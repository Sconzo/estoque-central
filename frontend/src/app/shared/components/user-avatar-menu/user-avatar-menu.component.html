<!-- Story 9.3: User Avatar Menu with Company Context Switching -->
<!-- AC1: Avatar Display -->
<!-- AC2: Menu Content with MatMenu -->
<!-- AC3: Company List with checkmark for current -->

<button
  mat-icon-button
  [matMenuTriggerFor]="userMenu"
  aria-label="Menu do usuário"
  class="avatar-button">
  <!-- AC1: Avatar with user initials or photo -->
  @if (currentUser()?.pictureUrl) {
    <img
      [src]="currentUser()!.pictureUrl"
      [alt]="currentUser()!.nome"
      class="user-avatar">
  } @else {
    <div class="user-initials-avatar" [style.background-color]="getAvatarColor()">
      {{ getUserInitials() }}
    </div>
  }
</button>

<!-- AC2: Dropdown menu (MatMenu) -->
<mat-menu #userMenu="matMenu" class="user-avatar-menu" xPosition="before">
  <!-- User info header -->
  <div class="menu-header" mat-menu-item [disableRipple]="true" (click)="$event.stopPropagation()">
    <div class="user-info">
      @if (currentUser()?.pictureUrl) {
        <img
          [src]="currentUser()!.pictureUrl"
          [alt]="currentUser()!.nome"
          class="header-avatar">
      } @else {
        <div class="header-initials-avatar" [style.background-color]="getAvatarColor()">
          {{ getUserInitials() }}
        </div>
      }
      <div class="user-details">
        <strong class="user-name">{{ currentUser()?.nome }}</strong>
        <small class="user-email">{{ currentUser()?.email }}</small>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Manage companies -->
  <button mat-menu-item routerLink="/select-company" aria-label="Gerenciar empresas" class="manage-companies-item">
    <mat-icon>business</mat-icon>
    <span>Gerenciar Empresas</span>
  </button>

  <mat-divider></mat-divider>

  <!-- Settings and logout -->
  <button mat-menu-item routerLink="/profile" aria-label="Ver perfil">
    <mat-icon>person</mat-icon>
    <span>Meu Perfil</span>
  </button>

  <button mat-menu-item routerLink="/configuracoes" aria-label="Configurações">
    <mat-icon>settings</mat-icon>
    <span>Configurações</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="logout()" aria-label="Sair do sistema" class="logout-item">
    <mat-icon>logout</mat-icon>
    <span>Sair</span>
  </button>
</mat-menu>
