<h2 mat-dialog-title>
  @if (isReadOnly) {
    Detalhes da Ordem de Compra
  } @else if (isEditMode) {
    Editar Ordem de Compra
  } @else {
    Nova Ordem de Compra
  }
</h2>

<mat-dialog-content>
  <form [formGroup]="poForm" class="po-form">
    <!-- Dados Gerais -->
    <div class="form-section">
      <h3>Dados Gerais</h3>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Fornecedor <span class="required">*</span></mat-label>
          <mat-select
            formControlName="supplierId"
            required
            aria-label="Fornecedor da ordem de compra"
            aria-required="true"
            [attr.aria-describedby]="poForm.get('supplierId')?.hasError('required') ? 'supplierId-error' : null">
            <!-- TODO: Load suppliers from service -->
            <mat-option value="">Selecione um fornecedor</mat-option>
          </mat-select>
          <mat-error id="supplierId-error" role="alert">Fornecedor é obrigatório</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Local de Estoque Destino <span class="required">*</span></mat-label>
          <mat-select
            formControlName="stockLocationId"
            required
            aria-label="Local de estoque de destino"
            aria-required="true"
            [attr.aria-describedby]="poForm.get('stockLocationId')?.hasError('required') ? 'stockLocationId-error' : null">
            <!-- TODO: Load locations from service -->
            <mat-option value="">Selecione um local</mat-option>
          </mat-select>
          <mat-error id="stockLocationId-error" role="alert">Local de estoque é obrigatório</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Data do Pedido <span class="required">*</span></mat-label>
          <input
            matInput
            [matDatepicker]="pickerOrderDate"
            formControlName="orderDate"
            required
            aria-label="Data do pedido de compra"
            aria-required="true"
            [attr.aria-describedby]="poForm.get('orderDate')?.hasError('required') ? 'orderDate-error' : null">
          <mat-datepicker-toggle matSuffix [for]="pickerOrderDate"></mat-datepicker-toggle>
          <mat-datepicker #pickerOrderDate></mat-datepicker>
          <mat-error id="orderDate-error" role="alert">Data do pedido é obrigatória</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Previsão de Entrega</mat-label>
          <input
            matInput
            [matDatepicker]="pickerDeliveryDate"
            formControlName="expectedDeliveryDate"
            aria-label="Previsão de entrega (opcional)">
          <mat-datepicker-toggle matSuffix [for]="pickerDeliveryDate"></mat-datepicker-toggle>
          <mat-datepicker #pickerDeliveryDate></mat-datepicker>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Observações</mat-label>
        <textarea
          matInput
          formControlName="notes"
          rows="3"
          aria-label="Observações sobre a ordem de compra (opcional)"></textarea>
      </mat-form-field>
    </div>

    <!-- Itens da Ordem -->
    <div class="form-section">
      <div class="section-header">
        <h3>Itens da Ordem</h3>
        @if (!isReadOnly) {
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addItem()"
            aria-label="Adicionar novo item à ordem de compra">
            <mat-icon>add</mat-icon>
            Adicionar Item
          </button>
        }
      </div>

      <div class="items-table-container">
        <table mat-table [dataSource]="items.controls" class="items-table" aria-label="Tabela de itens da ordem de compra">
          <!-- Product Column -->
          <ng-container matColumnDef="product">
            <th mat-header-cell *matHeaderCellDef>Produto <span class="required">*</span></th>
            <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
              <mat-form-field appearance="outline" class="table-field">
                <mat-select
                  formControlName="productId"
                  required
                  [attr.aria-label]="'Produto do item ' + (i + 1)"
                  aria-required="true">
                  <!-- TODO: Load products from service -->
                  <mat-option value="">Selecione um produto</mat-option>
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Quantidade <span class="required">*</span></th>
            <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
              <mat-form-field appearance="outline" class="table-field">
                <input
                  matInput
                  type="number"
                  formControlName="quantityOrdered"
                  step="0.01"
                  min="0.001"
                  required
                  [attr.aria-label]="'Quantidade do item ' + (i + 1)"
                  aria-required="true">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Unit Cost Column -->
          <ng-container matColumnDef="unitCost">
            <th mat-header-cell *matHeaderCellDef>Custo Unitário <span class="required">*</span></th>
            <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
              <mat-form-field appearance="outline" class="table-field">
                <input
                  matInput
                  type="number"
                  formControlName="unitCost"
                  step="0.01"
                  min="0"
                  required
                  [attr.aria-label]="'Custo unitário do item ' + (i + 1)"
                  aria-required="true">
                <span matPrefix>R$&nbsp;</span>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Total Column -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let item; let i = index">
              <strong [attr.aria-label]="'Total do item ' + (i + 1) + ': ' + (getItemTotal(i) | currency:'BRL')">{{ getItemTotal(i) | currency:'BRL' }}</strong>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let item; let i = index">
              @if (!isReadOnly) {
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="removeItem(i)"
                  [attr.aria-label]="'Remover item ' + (i + 1)">
                  <mat-icon>delete</mat-icon>
                </button>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- Total da Ordem -->
      <div class="order-total">
        <h3>Total da Ordem: {{ calculateTotals() | currency:'BRL' }}</h3>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button
    mat-button
    (click)="onCancel()"
    [attr.aria-label]="isReadOnly ? 'Fechar detalhes da ordem de compra' : 'Cancelar edição da ordem de compra'">
    @if (isReadOnly) {
      Fechar
    } @else {
      Cancelar
    }
  </button>
  @if (!isReadOnly) {
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="loading || poForm.invalid"
      [attr.aria-label]="loading ? 'Salvando ordem de compra...' : 'Salvar ordem de compra'"
      [attr.aria-disabled]="loading || poForm.invalid">
      @if (loading) {
        Salvando...
      } @else {
        Salvar
      }
    </button>
  }
</mat-dialog-actions>
