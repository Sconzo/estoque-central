<div class="product-list-container">
  <!-- Header -->
  <div class="header">
    <h2>Produtos</h2>
    <div class="header-actions">
      <button
        mat-stroked-button
        color="primary"
        (click)="importProducts()"
        [disabled]="loading"
        aria-label="Importar produtos via CSV">
        <mat-icon>upload_file</mat-icon>
        Importar CSV
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="createProduct()"
        [disabled]="loading"
        aria-label="Criar novo produto">
        <mat-icon>add</mat-icon>
        Novo Produto
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <!-- Search -->
    <mat-form-field appearance="outline" class="filter-search">
      <mat-label>Busca Rápida</mat-label>
      <input
        matInput
        [(ngModel)]="filters.query"
        (ngModelChange)="onSearchChange($event)"
        placeholder="Nome, SKU ou código de barras..."
        aria-label="Buscar produtos"
      />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <!-- Category Filter -->
    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Categoria</mat-label>
      <mat-select
        [(ngModel)]="filters.categoryId"
        (ngModelChange)="onCategoryChange()"
        aria-label="Filtrar por categoria">
        <mat-option [value]="undefined">Todas as categorias</mat-option>
        <mat-option *ngFor="let category of categories" [value]="category.id">
          {{ category.name }}
        </mat-option>
      </mat-select>
      <mat-icon matPrefix>category</mat-icon>
    </mat-form-field>

    <!-- Status Filter -->
    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Status</mat-label>
      <mat-select
        [(ngModel)]="filters.status"
        (ngModelChange)="onStatusChange()"
        aria-label="Filtrar por status">
        <mat-option [value]="undefined">Todos os status</mat-option>
        <mat-option [value]="ProductStatus.ACTIVE">{{ STATUS_LABELS[ProductStatus.ACTIVE] }}</mat-option>
        <mat-option [value]="ProductStatus.INACTIVE">{{ STATUS_LABELS[ProductStatus.INACTIVE] }}</mat-option>
        <mat-option [value]="ProductStatus.DISCONTINUED">{{ STATUS_LABELS[ProductStatus.DISCONTINUED] }}</mat-option>
      </mat-select>
      <mat-icon matPrefix>filter_list</mat-icon>
    </mat-form-field>

    <!-- Clear Filters -->
    <div class="filter-actions">
      <button
        mat-stroked-button
        (click)="clearFilters()"
        [disabled]="loading"
        aria-label="Limpar todos os filtros">
        <mat-icon>clear</mat-icon>
        Limpar Filtros
      </button>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary" *ngIf="products && !loading">
    <p>
      Mostrando <strong>{{ products.content.length }}</strong> de
      <strong>{{ products.totalElements }}</strong> produtos
    </p>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" *ngIf="loading && !products" role="status" aria-live="polite">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando produtos...</p>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error" role="alert">
    <mat-icon color="warn" class="error-icon">warning</mat-icon>
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="loadProducts()" aria-label="Tentar carregar produtos novamente">
      <mat-icon>refresh</mat-icon>
      Tentar Novamente
    </button>
  </div>

  <!-- Product Table -->
  <div class="table-container" *ngIf="!loading && !error && products">
    <div class="empty-state" *ngIf="products.empty">
      <mat-icon class="empty-icon">inventory_2</mat-icon>
      <p>Nenhum produto encontrado.</p>
      <p class="hint">Tente ajustar os filtros ou cadastre um novo produto.</p>
      <button mat-raised-button color="primary" (click)="createProduct()" aria-label="Cadastrar primeiro produto">
        <mat-icon>add</mat-icon>
        Cadastrar Primeiro Produto
      </button>
    </div>

    <table mat-table [dataSource]="products.content" class="product-table" *ngIf="!products.empty">
      <!-- SKU Column -->
      <ng-container matColumnDef="sku">
        <th mat-header-cell *matHeaderCellDef>SKU</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <strong>{{ product.sku }}</strong>
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nome</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <strong>{{ product.name }}</strong>
          <div class="subtitle" *ngIf="product.description">
            {{ product.description | slice:0:50 }}{{ product.description && product.description.length > 50 ? '...' : '' }}
          </div>
        </td>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Categoria</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <span *ngIf="product.categoryName">{{ product.categoryName }}</span>
          <span *ngIf="!product.categoryName" class="text-muted">-</span>
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Preço</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <strong>{{ formatCurrency(product.price) }}</strong>
        </td>
      </ng-container>

      <!-- Cost Column -->
      <ng-container matColumnDef="cost">
        <th mat-header-cell *matHeaderCellDef>Custo</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <span *ngIf="product.cost">{{ formatCurrency(product.cost) }}</span>
          <span *ngIf="!product.cost" class="text-muted">-</span>
        </td>
      </ng-container>

      <!-- Inventory Column -->
      <ng-container matColumnDef="inventory">
        <th mat-header-cell *matHeaderCellDef>Estoque</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <span *ngIf="product.controlsInventory" class="text-muted">Controla</span>
          <span *ngIf="!product.controlsInventory" class="text-muted">Não controla</span>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let product" (click)="viewProduct(product)">
          <mat-chip [class]="getStatusClass(product.status)">
            {{ getStatusLabel(product.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let product" class="actions">
          <button
            mat-icon-button
            (click)="viewProduct(product); $event.stopPropagation()"
            [attr.aria-label]="'Visualizar produto ' + product.name"
            matTooltip="Visualizar Produto">
            <mat-icon>visibility</mat-icon>
          </button>
          <button
            mat-icon-button
            color="primary"
            (click)="editProduct(product); $event.stopPropagation()"
            [attr.aria-label]="'Editar produto ' + product.name"
            matTooltip="Editar Produto">
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            color="accent"
            (click)="syncStockToMarketplace(product); $event.stopPropagation()"
            [attr.aria-label]="'Sincronizar estoque do produto ' + product.name"
            matTooltip="Sincronizar Estoque com Marketplaces"
            *ngIf="product.controlsInventory">
            <mat-icon>sync</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            (click)="deleteProduct(product, $event)"
            [attr.aria-label]="'Excluir produto ' + product.name"
            matTooltip="Excluir Produto">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="clickable"></tr>
    </table>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="products && !products.empty"
    [length]="products.totalElements"
    [pageSize]="filters.size"
    [pageIndex]="products.number"
    [pageSizeOptions]="[10, 20, 50, 100]"
    (page)="onPageChange($event)"
    aria-label="Selecionar página de produtos"
    showFirstLastButtons>
  </mat-paginator>
</div>
