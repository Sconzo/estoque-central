<div class="product-form-container">
  <!-- Header -->
  <div class="header">
    <h2 id="form-title">{{ isEditMode ? 'Editar Produto' : 'Novo Produto' }}</h2>
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="loading" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <p>Carregando produto...</p>
  </div>

  <!-- Error Message -->
  <div class="error-banner" *ngIf="error" role="alert">
    <mat-icon class="error-icon" aria-hidden="true">warning</mat-icon>
    <p>{{ error }}</p>
  </div>

  <!-- Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" *ngIf="!loading" aria-labelledby="form-title">
    <div class="form-sections">
      <!-- Product Type (only in create mode) -->
      <div class="form-section" *ngIf="!isEditMode">
        <h3>Tipo de Produto</h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo <span class="required">*</span></mat-label>
            <mat-select
              [value]="selectedProductType"
              (selectionChange)="onProductTypeChange($event)"
              [disabled]="createdProductId !== null"
              required
              aria-label="Tipo de produto"
              aria-required="true">
              <mat-option *ngFor="let option of PRODUCT_TYPE_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- BOM Type (only for COMPOSITE products) -->
          <mat-form-field appearance="outline" class="full-width" *ngIf="selectedProductType === ProductType.COMPOSITE">
            <mat-label>Tipo de Composição <span class="required">*</span></mat-label>
            <mat-select
              formControlName="bomType"
              required
              aria-label="Tipo de composição do kit"
              aria-required="true">
              <mat-option *ngFor="let option of BOM_TYPE_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="productForm.get('bomType')?.hasError('required')">
              Tipo de composição é obrigatório para kits
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Basic Information -->
      <div class="form-section">
        <h3>Informações Básicas</h3>

        <div class="form-row">
          <!-- Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nome do Produto <span class="required">*</span></mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Ex: Notebook Dell Inspiron 15"
              required
              aria-label="Nome do Produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('name')?.hasError('required') || productForm.get('name')?.hasError('maxlength') ? 'name-error' : null">
            <mat-error id="name-error" role="alert" *ngIf="productForm.get('name')?.hasError('required')">
              Nome é obrigatório
            </mat-error>
            <mat-error id="name-error" role="alert" *ngIf="productForm.get('name')?.hasError('maxlength')">
              Máximo de 200 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- SKU -->
          <mat-form-field appearance="outline">
            <mat-label>SKU <span class="required">*</span></mat-label>
            <input
              matInput
              formControlName="sku"
              placeholder="Ex: NOTE-DELL-I15-001"
              [readonly]="isEditMode"
              required
              aria-label="SKU - Código único do produto"
              aria-required="true"
              [attr.aria-describedby]="isEditMode ? 'sku-hint' : (productForm.get('sku')?.hasError('required') || productForm.get('sku')?.hasError('maxlength') ? 'sku-error' : null)">
            <mat-hint id="sku-hint" *ngIf="isEditMode">SKU não pode ser alterado</mat-hint>
            <mat-error id="sku-error" role="alert" *ngIf="productForm.get('sku')?.hasError('required')">
              SKU é obrigatório
            </mat-error>
            <mat-error id="sku-error" role="alert" *ngIf="productForm.get('sku')?.hasError('maxlength')">
              Máximo de 100 caracteres
            </mat-error>
          </mat-form-field>

          <!-- Barcode -->
          <mat-form-field appearance="outline">
            <mat-label>Código de Barras</mat-label>
            <input
              matInput
              formControlName="barcode"
              placeholder="Ex: 7891234567890"
              aria-label="Código de Barras"
              [attr.aria-describedby]="productForm.get('barcode')?.hasError('maxlength') ? 'barcode-error' : null">
            <mat-error id="barcode-error" role="alert" *ngIf="productForm.get('barcode')?.hasError('maxlength')">
              Máximo de 100 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descrição</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Descrição detalhada do produto..."
              rows="3"
              aria-label="Descrição detalhada do produto"></textarea>
          </mat-form-field>
        </div>
      </div>

      <!-- Category & Classification -->
      <div class="form-section">
        <h3>Categoria e Classificação</h3>

        <div class="form-row">
          <!-- Category -->
          <mat-form-field appearance="outline">
            <mat-label>Categoria <span class="required">*</span></mat-label>
            <mat-select
              formControlName="categoryId"
              required
              aria-label="Categoria do produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('categoryId')?.hasError('required') ? 'category-error' : null">
              <mat-option value="">Selecione uma categoria</mat-option>
              <mat-option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </mat-option>
            </mat-select>
            <mat-error id="category-error" role="alert" *ngIf="productForm.get('categoryId')?.hasError('required')">
              Categoria é obrigatória
            </mat-error>
          </mat-form-field>

          <!-- Status -->
          <mat-form-field appearance="outline">
            <mat-label>Status <span class="required">*</span></mat-label>
            <mat-select
              formControlName="status"
              required
              aria-label="Status do produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('status')?.hasError('required') ? 'status-error' : null">
              <mat-option *ngFor="let option of STATUS_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error id="status-error" role="alert" *ngIf="productForm.get('status')?.hasError('required')">
              Status é obrigatório
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Pricing -->
      <div class="form-section">
        <h3>Preços</h3>

        <div class="form-row">
          <!-- Price -->
          <mat-form-field appearance="outline">
            <mat-label>Preço de Venda <span class="required">*</span></mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="price"
              placeholder="0,00"
              required
              aria-label="Preço de Venda"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('price')?.hasError('required') || productForm.get('price')?.hasError('min') ? 'price-error' : null">
            <mat-error id="price-error" role="alert" *ngIf="productForm.get('price')?.hasError('required')">
              Preço é obrigatório
            </mat-error>
            <mat-error id="price-error" role="alert" *ngIf="productForm.get('price')?.hasError('min')">
              Preço deve ser maior ou igual a 0
            </mat-error>
          </mat-form-field>

          <!-- Cost -->
          <mat-form-field appearance="outline">
            <mat-label>Custo</mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="cost"
              placeholder="0,00"
              aria-label="Custo do produto"
              [attr.aria-describedby]="productForm.get('cost')?.hasError('min') ? 'cost-error' : null">
            <mat-error id="cost-error" role="alert" *ngIf="productForm.get('cost')?.hasError('min')">
              Custo deve ser maior ou igual a 0
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Inventory -->
      <div class="form-section">
        <h3>Controle de Estoque</h3>

        <div class="form-row">
          <!-- Unit -->
          <mat-form-field appearance="outline">
            <mat-label>Unidade de Medida <span class="required">*</span></mat-label>
            <mat-select
              formControlName="unit"
              required
              aria-label="Unidade de Medida"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('unit')?.hasError('required') ? 'unit-error' : null">
              <mat-option *ngFor="let option of UNIT_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error id="unit-error" role="alert" *ngIf="productForm.get('unit')?.hasError('required')">
              Unidade é obrigatória
            </mat-error>
          </mat-form-field>

          <!-- Controls Inventory -->
          <div class="checkbox-group">
            <mat-checkbox
              formControlName="controlsInventory"
              aria-label="Controla estoque do produto"
              [attr.aria-describedby]="'controls-inventory-hint'">
              Controla estoque
            </mat-checkbox>
            <span class="help-text" id="controls-inventory-hint">
              Marque esta opção se este produto precisa ter controle de estoque.
              Desmarque para produtos de serviço ou sem necessidade de controle.
            </span>
          </div>
        </div>
      </div>

      <!-- BOM Components Section (only for COMPOSITE in create mode) -->
      <div class="form-section bom-components-section" *ngIf="!isEditMode && selectedProductType === ProductType.COMPOSITE">
        <div class="section-header-with-action">
          <h3>Componentes do Kit (BOM)</h3>
        </div>

        <p class="section-description">
          Adicione os produtos que compõem este kit. Pesquise pelo nome ou SKU e defina a quantidade de cada componente.
        </p>

        <!-- Product Search -->
        <div class="component-search">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar produto para adicionar</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="productSearchQuery"
              [ngModelOptions]="{standalone: true}"
              (ngModelChange)="onProductSearch($event)"
              [matAutocomplete]="productAuto"
              placeholder="Digite o nome ou SKU do produto...">
            <mat-icon matSuffix>search</mat-icon>
            <mat-autocomplete #productAuto="matAutocomplete" (optionSelected)="addBomComponent($event.option.value)">
              <mat-option *ngFor="let product of productSearchResults" [value]="product">
                <div class="product-option">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-sku">SKU: {{ product.sku }}</span>
                  <span class="product-price">R$ {{ product.price | number:'1.2-2' }}</span>
                </div>
              </mat-option>
              <mat-option *ngIf="searchingProducts" disabled>
                <div class="searching-indicator">
                  <span>Buscando...</span>
                </div>
              </mat-option>
              <mat-option *ngIf="!searchingProducts && productSearchQuery.length >= 2 && productSearchResults.length === 0" disabled>
                <span>Nenhum produto encontrado</span>
              </mat-option>
            </mat-autocomplete>
            <mat-hint>Digite pelo menos 2 caracteres para buscar</mat-hint>
          </mat-form-field>
        </div>

        <!-- Components List -->
        <div class="components-list" *ngIf="bomComponents.length > 0">
          <h4>Componentes adicionados ({{ bomComponents.length }})</h4>

          <div class="component-card" *ngFor="let component of bomComponents; let i = index">
            <div class="component-info">
              <span class="component-name">{{ component.product.name }}</span>
              <span class="component-sku">SKU: {{ component.product.sku }}</span>
            </div>

            <div class="component-quantity">
              <mat-form-field appearance="outline" class="quantity-field">
                <mat-label>Qtd</mat-label>
                <input
                  matInput
                  type="number"
                  min="1"
                  step="1"
                  [(ngModel)]="component.quantityRequired"
                  [ngModelOptions]="{standalone: true}"
                  (ngModelChange)="updateComponentQuantity(i, $event)">
              </mat-form-field>
              <span class="component-unit">{{ component.product.unit }}</span>
            </div>

            <button
              mat-icon-button
              type="button"
              color="warn"
              (click)="removeBomComponent(i)"
              title="Remover componente">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-components-message" *ngIf="bomComponents.length === 0">
          <mat-icon>inventory_2</mat-icon>
          <p>Nenhum componente adicionado. Use a busca acima para adicionar produtos ao kit.</p>
        </div>

        <!-- Components Summary -->
        <div class="components-summary" *ngIf="bomComponents.length > 0">
          <mat-icon>info</mat-icon>
          <span>
            Este kit terá <strong>{{ bomComponents.length }}</strong> componente(s).
            <span *ngIf="productForm.get('bomType')?.value === 'VIRTUAL'">
              O estoque será calculado automaticamente com base nos componentes.
            </span>
            <span *ngIf="productForm.get('bomType')?.value === 'PHYSICAL'">
              O kit terá controle de estoque próprio (pré-montado).
            </span>
          </span>
        </div>
      </div>

      <!-- Variant Attributes Section (only for VARIANT_PARENT in create mode, before product is saved) -->
      <div class="form-section variant-attributes-section" *ngIf="!isEditMode && selectedProductType === ProductType.VARIANT_PARENT && !createdProductId">
        <div class="section-header-with-action">
          <h3>Atributos de Variação</h3>
          <button
            mat-stroked-button
            type="button"
            color="primary"
            (click)="addAttribute()"
            [disabled]="variantAttributes.length >= 3">
            <mat-icon>add</mat-icon>
            Adicionar Atributo
          </button>
        </div>

        <p class="section-description">
          Defina os atributos (ex: Cor, Tamanho) e seus valores possíveis. As variantes serão geradas a partir das combinações.
          <strong>Máximo: 3 atributos, 100 variantes.</strong>
        </p>

        <!-- Attributes List -->
        <div class="attributes-list">
          <div *ngFor="let attribute of variantAttributes; let i = index" class="attribute-card">
            <div class="attribute-header">
              <mat-form-field appearance="outline" class="attribute-name-field">
                <mat-label>Nome do Atributo <span class="required">*</span></mat-label>
                <input
                  matInput
                  [(ngModel)]="attribute.name"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Ex: Cor, Tamanho, Voltagem..."
                  (ngModelChange)="calculateEstimatedVariants()">
              </mat-form-field>

              <button
                mat-icon-button
                type="button"
                color="warn"
                (click)="removeAttribute(i)"
                title="Remover Atributo"
                class="remove-attribute-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <div class="attribute-values-section">
              <label class="values-label">Valores:</label>

              <div class="values-input-row">
                <mat-form-field appearance="outline" class="value-input-field">
                  <mat-label>Adicionar valor</mat-label>
                  <input
                    matInput
                    #valueInput
                    placeholder="Digite e pressione Enter"
                    [disabled]="!attribute.name"
                    (keydown)="onValueInputKeydown($event, i, valueInput)">
                  <mat-hint *ngIf="!attribute.name">Defina o nome do atributo primeiro</mat-hint>
                </mat-form-field>
                <button
                  mat-stroked-button
                  type="button"
                  (click)="addValueToAttribute(i, valueInput)"
                  [disabled]="!attribute.name">
                  <mat-icon>add</mat-icon>
                  Adicionar
                </button>
              </div>

              <!-- Values Chips -->
              <div class="values-chips" *ngIf="attribute.values.length > 0">
                <span *ngFor="let value of attribute.values; let vi = index" class="value-chip">
                  {{ value }}
                  <button type="button" class="chip-remove-btn" (click)="removeValue(i, vi)" title="Remover valor">
                    <mat-icon>close</mat-icon>
                  </button>
                </span>
              </div>

              <p class="empty-values-message" *ngIf="attribute.values.length === 0 && attribute.name">
                Nenhum valor adicionado. Adicione pelo menos um valor.
              </p>
            </div>
          </div>

          <p class="empty-attributes-message" *ngIf="variantAttributes.length === 0">
            Nenhum atributo definido. Clique em "Adicionar Atributo" para começar.
          </p>
        </div>

        <!-- Estimated Variants Counter -->
        <div class="estimated-variants-counter" *ngIf="estimatedVariantCount > 0">
          <mat-icon [class.warning-icon]="estimatedVariantCount > 100">info</mat-icon>
          <span>
            Variantes que serão geradas: <strong [class.warning-text]="estimatedVariantCount > 100">{{ estimatedVariantCount }}</strong>
            <span class="warning-hint" *ngIf="estimatedVariantCount > 100"> (Máximo permitido: 100)</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Form Actions (for simple products or edit mode) -->
    <div class="form-actions" *ngIf="selectedProductType === ProductType.SIMPLE || isEditMode">
      <button
        mat-stroked-button
        type="button"
        (click)="cancel()"
        [disabled]="saving"
        aria-label="Cancelar e voltar para lista de produtos">
        Cancelar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="saving || productForm.invalid"
        [attr.aria-label]="saving ? 'Salvando produto...' : (isEditMode ? 'Salvar alterações do produto' : 'Criar novo produto')">
        <mat-icon *ngIf="!saving">save</mat-icon>
        {{ saving ? 'Salvando...' : (isEditMode ? 'Salvar Alterações' : 'Criar Produto') }}
      </button>
    </div>

    <!-- Form Actions (for composite/BOM products) -->
    <div class="form-actions" *ngIf="selectedProductType === ProductType.COMPOSITE && !isEditMode">
      <button
        mat-stroked-button
        type="button"
        (click)="cancel()"
        [disabled]="saving"
        aria-label="Cancelar e voltar para lista de produtos">
        Cancelar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="saving || productForm.invalid || !canCreateCompositeProduct()"
        [attr.aria-label]="saving ? 'Salvando kit...' : 'Criar kit com componentes'">
        <mat-icon *ngIf="!saving">save</mat-icon>
        {{ saving ? 'Salvando...' : 'Criar Kit/Composto' }}
      </button>
    </div>

    <!-- Variant Parent Actions (save base product first) -->
    <div class="form-actions" *ngIf="selectedProductType === ProductType.VARIANT_PARENT && !isEditMode && !createdProductId">
      <button
        mat-stroked-button
        type="button"
        (click)="cancel()"
        [disabled]="saving"
        aria-label="Cancelar e voltar para lista de produtos">
        Cancelar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="saving || productForm.invalid || !canCreateVariantProduct()"
        [attr.aria-label]="saving ? 'Salvando produto...' : 'Criar produto e gerar variantes'">
        <mat-icon *ngIf="!saving">save</mat-icon>
        {{ saving ? 'Salvando...' : 'Criar Produto e Configurar Variantes' }}
      </button>
    </div>
  </form>

  <!-- Variant Matrix (shown after base product is created) -->
  <div class="variant-section" *ngIf="!isEditMode && selectedProductType === ProductType.VARIANT_PARENT && createdProductId">
    <app-variant-matrix
      [parentProductId]="createdProductId"
      [baseSku]="productForm.get('sku')?.value || ''"
      [basePrice]="productForm.get('price')?.value || 0"
      [baseCost]="productForm.get('cost')?.value || 0"
      [initialAttributes]="variantAttributes"
      (variantsGenerated)="onVariantsGenerated($event)"
    ></app-variant-matrix>
  </div>
</div>
