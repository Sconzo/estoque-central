<div class="product-form-container">
  <!-- Header -->
  <div class="header">
    <h2 id="form-title">{{ isEditMode ? 'Editar Produto' : 'Novo Produto' }}</h2>
  </div>

  <!-- Loading -->
  <div class="loading-spinner" *ngIf="loading" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <p>Carregando produto...</p>
  </div>

  <!-- Error Message -->
  <div class="error-banner" *ngIf="error" role="alert">
    <mat-icon class="error-icon" aria-hidden="true">warning</mat-icon>
    <p>{{ error }}</p>
  </div>

  <!-- Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" *ngIf="!loading" aria-labelledby="form-title">
    <div class="form-sections">
      <!-- Product Type (only in create mode) -->
      <div class="form-section" *ngIf="!isEditMode">
        <h3>Tipo de Produto</h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo <span class="required">*</span></mat-label>
            <mat-select
              [value]="selectedProductType"
              (selectionChange)="onProductTypeChange($event)"
              [disabled]="createdProductId !== null"
              required
              aria-label="Tipo de produto"
              aria-required="true"
              aria-describedby="product-type-hint">
              <mat-option *ngFor="let option of PRODUCT_TYPE_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-hint id="product-type-hint">
              <strong>Produto Simples:</strong> produto único sem variações.<br>
              <strong>Produto com Variantes:</strong> produto com múltiplas variações (ex: cores, tamanhos).<br>
              <strong>Kit/Composto:</strong> produto formado por outros produtos (BOM).
            </mat-hint>
          </mat-form-field>

          <!-- BOM Type (only for COMPOSITE products) -->
          <mat-form-field appearance="outline" class="full-width" *ngIf="selectedProductType === ProductType.COMPOSITE">
            <mat-label>Tipo de Composição <span class="required">*</span></mat-label>
            <mat-select
              formControlName="bomType"
              required
              aria-label="Tipo de composição do kit"
              aria-required="true"
              aria-describedby="bom-type-hint">
              <mat-option *ngFor="let option of BOM_TYPE_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-hint id="bom-type-hint">
              <strong>Virtual:</strong> estoque calculado automaticamente dos componentes.<br>
              <strong>Físico:</strong> kit pré-montado com controle de estoque próprio.
            </mat-hint>
            <mat-error *ngIf="productForm.get('bomType')?.hasError('required')">
              Tipo de composição é obrigatório para kits
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Basic Information -->
      <div class="form-section">
        <h3>Informações Básicas</h3>

        <div class="form-row">
          <!-- Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nome do Produto <span class="required">*</span></mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Ex: Notebook Dell Inspiron 15"
              required
              aria-label="Nome do Produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('name')?.hasError('required') || productForm.get('name')?.hasError('maxlength') ? 'name-error' : null">
            <mat-error id="name-error" role="alert" *ngIf="productForm.get('name')?.hasError('required')">
              Nome é obrigatório
            </mat-error>
            <mat-error id="name-error" role="alert" *ngIf="productForm.get('name')?.hasError('maxlength')">
              Máximo de 200 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- SKU -->
          <mat-form-field appearance="outline">
            <mat-label>SKU <span class="required">*</span></mat-label>
            <input
              matInput
              formControlName="sku"
              placeholder="Ex: NOTE-DELL-I15-001"
              [readonly]="isEditMode"
              required
              aria-label="SKU - Código único do produto"
              aria-required="true"
              [attr.aria-describedby]="isEditMode ? 'sku-hint' : (productForm.get('sku')?.hasError('required') || productForm.get('sku')?.hasError('maxlength') ? 'sku-error' : null)">
            <mat-hint id="sku-hint" *ngIf="isEditMode">SKU não pode ser alterado</mat-hint>
            <mat-error id="sku-error" role="alert" *ngIf="productForm.get('sku')?.hasError('required')">
              SKU é obrigatório
            </mat-error>
            <mat-error id="sku-error" role="alert" *ngIf="productForm.get('sku')?.hasError('maxlength')">
              Máximo de 100 caracteres
            </mat-error>
          </mat-form-field>

          <!-- Barcode -->
          <mat-form-field appearance="outline">
            <mat-label>Código de Barras</mat-label>
            <input
              matInput
              formControlName="barcode"
              placeholder="Ex: 7891234567890"
              aria-label="Código de Barras"
              [attr.aria-describedby]="productForm.get('barcode')?.hasError('maxlength') ? 'barcode-error' : null">
            <mat-error id="barcode-error" role="alert" *ngIf="productForm.get('barcode')?.hasError('maxlength')">
              Máximo de 100 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descrição</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Descrição detalhada do produto..."
              rows="3"
              aria-label="Descrição detalhada do produto"></textarea>
          </mat-form-field>
        </div>
      </div>

      <!-- Category & Classification -->
      <div class="form-section">
        <h3>Categoria e Classificação</h3>

        <div class="form-row">
          <!-- Category -->
          <mat-form-field appearance="outline">
            <mat-label>Categoria <span class="required">*</span></mat-label>
            <mat-select
              formControlName="categoryId"
              required
              aria-label="Categoria do produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('categoryId')?.hasError('required') ? 'category-error' : null">
              <mat-option value="">Selecione uma categoria</mat-option>
              <mat-option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </mat-option>
            </mat-select>
            <mat-error id="category-error" role="alert" *ngIf="productForm.get('categoryId')?.hasError('required')">
              Categoria é obrigatória
            </mat-error>
          </mat-form-field>

          <!-- Status -->
          <mat-form-field appearance="outline">
            <mat-label>Status <span class="required">*</span></mat-label>
            <mat-select
              formControlName="status"
              required
              aria-label="Status do produto"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('status')?.hasError('required') ? 'status-error' : null">
              <mat-option *ngFor="let option of STATUS_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error id="status-error" role="alert" *ngIf="productForm.get('status')?.hasError('required')">
              Status é obrigatório
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Pricing -->
      <div class="form-section">
        <h3>Preços</h3>

        <div class="form-row">
          <!-- Price -->
          <mat-form-field appearance="outline">
            <mat-label>Preço de Venda <span class="required">*</span></mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="price"
              placeholder="0,00"
              required
              aria-label="Preço de Venda"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('price')?.hasError('required') || productForm.get('price')?.hasError('min') ? 'price-error' : null">
            <mat-error id="price-error" role="alert" *ngIf="productForm.get('price')?.hasError('required')">
              Preço é obrigatório
            </mat-error>
            <mat-error id="price-error" role="alert" *ngIf="productForm.get('price')?.hasError('min')">
              Preço deve ser maior ou igual a 0
            </mat-error>
          </mat-form-field>

          <!-- Cost -->
          <mat-form-field appearance="outline">
            <mat-label>Custo</mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="cost"
              placeholder="0,00"
              aria-label="Custo do produto"
              [attr.aria-describedby]="productForm.get('cost')?.hasError('min') ? 'cost-error' : null">
            <mat-error id="cost-error" role="alert" *ngIf="productForm.get('cost')?.hasError('min')">
              Custo deve ser maior ou igual a 0
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Inventory -->
      <div class="form-section">
        <h3>Controle de Estoque</h3>

        <div class="form-row">
          <!-- Unit -->
          <mat-form-field appearance="outline">
            <mat-label>Unidade de Medida <span class="required">*</span></mat-label>
            <mat-select
              formControlName="unit"
              required
              aria-label="Unidade de Medida"
              aria-required="true"
              [attr.aria-describedby]="productForm.get('unit')?.hasError('required') ? 'unit-error' : null">
              <mat-option *ngFor="let option of UNIT_OPTIONS" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-error id="unit-error" role="alert" *ngIf="productForm.get('unit')?.hasError('required')">
              Unidade é obrigatória
            </mat-error>
          </mat-form-field>

          <!-- Controls Inventory -->
          <div class="checkbox-group">
            <mat-checkbox
              formControlName="controlsInventory"
              aria-label="Controla estoque do produto"
              [attr.aria-describedby]="'controls-inventory-hint'">
              Controla estoque
            </mat-checkbox>
            <span class="help-text" id="controls-inventory-hint">
              Marque esta opção se este produto precisa ter controle de estoque.
              Desmarque para produtos de serviço ou sem necessidade de controle.
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions (for simple products, composite products, or edit mode) -->
    <div class="form-actions" *ngIf="selectedProductType === ProductType.SIMPLE || selectedProductType === ProductType.COMPOSITE || isEditMode">
      <button
        mat-stroked-button
        type="button"
        (click)="cancel()"
        [disabled]="saving"
        aria-label="Cancelar e voltar para lista de produtos">
        Cancelar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="saving || productForm.invalid"
        [attr.aria-label]="saving ? 'Salvando produto...' : (isEditMode ? 'Salvar alterações do produto' : 'Criar novo produto')">
        <mat-icon *ngIf="!saving">save</mat-icon>
        {{ saving ? 'Salvando...' : (isEditMode ? 'Salvar Alterações' : 'Criar Produto') }}
      </button>
    </div>

    <!-- Variant Parent Actions (save base product first) -->
    <div class="form-actions" *ngIf="selectedProductType === ProductType.VARIANT_PARENT && !isEditMode && !createdProductId">
      <button
        mat-stroked-button
        type="button"
        (click)="cancel()"
        [disabled]="saving"
        aria-label="Cancelar e voltar para lista de produtos">
        Cancelar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="saving || productForm.invalid"
        [attr.aria-label]="saving ? 'Salvando produto base...' : 'Criar produto base para variantes'">
        <mat-icon *ngIf="!saving">save</mat-icon>
        {{ saving ? 'Salvando...' : 'Criar Produto Base' }}
      </button>
    </div>
  </form>

  <!-- Variant Matrix (shown after base product is created) -->
  <div class="variant-section" *ngIf="!isEditMode && selectedProductType === ProductType.VARIANT_PARENT && createdProductId">
    <app-variant-matrix
      [parentProductId]="createdProductId"
      [baseSku]="productForm.get('sku')?.value || ''"
      [basePrice]="productForm.get('price')?.value || 0"
      [baseCost]="productForm.get('cost')?.value || 0"
      (variantsGenerated)="onVariantsGenerated($event)"
    ></app-variant-matrix>
  </div>
</div>
