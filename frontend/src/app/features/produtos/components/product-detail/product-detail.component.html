<div class="product-detail-container">
  <!-- Loading -->
  <div class="loading-spinner" *ngIf="loading">
    <div class="spinner"></div>
    <p>Carregando produto...</p>
  </div>

  <!-- Error -->
  <div class="error-banner" *ngIf="error">
    <mat-icon>warning</mat-icon>
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="goBack()">Voltar</button>
  </div>

  <!-- Product Detail -->
  <ng-container *ngIf="!loading && !error && product">
    <!-- Header -->
    <div class="detail-header">
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Voltar para lista">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="title-section">
          <h1>{{ product.name }}</h1>
          <div class="badges">
            <span class="type-badge" [ngClass]="'type-' + product.type.toLowerCase()">
              {{ TYPE_LABELS[product.type] }}
            </span>
            <span class="status-badge" [ngClass]="'status-' + product.status.toLowerCase()">
              {{ STATUS_LABELS[product.status] }}
            </span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="editProduct()">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="detail-content">
      <!-- Basic Information -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            Informações Básicas
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>SKU</label>
              <span class="sku-value">{{ product.sku }}</span>
            </div>
            <div class="info-item">
              <label>Código de Barras</label>
              <span>{{ product.barcode || '-' }}</span>
            </div>
            <div class="info-item">
              <label>Categoria</label>
              <span>{{ product.categoryName || product.categoryPath || '-' }}</span>
            </div>
            <div class="info-item full-width" *ngIf="product.description">
              <label>Descrição</label>
              <span class="description">{{ product.description }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Pricing -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>attach_money</mat-icon>
            Preços
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid pricing-grid">
            <div class="info-item">
              <label>Preço de Venda</label>
              <span class="price-value">R$ {{ product.price | number:'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <label>Custo</label>
              <span class="cost-value">{{ product.cost ? ('R$ ' + (product.cost | number:'1.2-2')) : '-' }}</span>
            </div>
            <div class="info-item" *ngIf="calculateMargin() !== null">
              <label>Margem</label>
              <span class="margin-value" [ngClass]="{'positive': calculateMargin()! > 0, 'negative': calculateMargin()! < 0}">
                {{ calculateMargin() | number:'1.1-1' }}%
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Inventory Control -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>inventory</mat-icon>
            Controle de Estoque
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Unidade de Medida</label>
              <span>{{ getUnitLabel(product.unit) }}</span>
            </div>
            <div class="info-item">
              <label>Controla Estoque</label>
              <span [ngClass]="{'controls-yes': product.controlsInventory, 'controls-no': !product.controlsInventory}">
                {{ product.controlsInventory ? 'Sim' : 'Não' }}
              </span>
            </div>
            <div class="info-item" *ngIf="product.type === ProductType.COMPOSITE && product.bomType">
              <label>Tipo de Composição</label>
              <span>{{ getBomTypeLabel(product.bomType) }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Stock Levels for SIMPLE/COMPOSITE (when controlsInventory=true) -->
      <mat-card class="detail-card" *ngIf="product.controlsInventory && product.type !== ProductType.VARIANT_PARENT">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>warehouse</mat-icon>
            Estoque por Localização
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="loading-inline" *ngIf="loadingStock">
            <div class="spinner-small"></div>
            <span>Carregando estoque...</span>
          </div>

          <!-- Stock Summary -->
          <div class="info-grid stock-summary" *ngIf="!loadingStock && stockData">
            <div class="info-item">
              <label>Quantidade Disponível</label>
              <span class="stock-value">{{ stockData.totalQuantityAvailable | number:'1.0-2' }}</span>
            </div>
            <div class="info-item">
              <label>Reservado</label>
              <span class="stock-reserved">{{ stockData.totalReservedQuantity | number:'1.0-2' }}</span>
            </div>
            <div class="info-item">
              <label>Disponível p/ Venda</label>
              <span class="stock-for-sale">{{ stockData.totalQuantityForSale | number:'1.0-2' }}</span>
            </div>
          </div>

          <!-- Stock by Location Table -->
          <div class="table-container" *ngIf="!loadingStock && stockData && stockData.byLocation && stockData.byLocation.length > 0">
            <table mat-table [dataSource]="stockData.byLocation" class="stock-table">
              <ng-container matColumnDef="location">
                <th mat-header-cell *matHeaderCellDef>Localização</th>
                <td mat-cell *matCellDef="let stock">
                  <span class="location-name">{{ stock.locationName }}</span>
                  <span class="location-code">{{ stock.locationCode }}</span>
                </td>
              </ng-container>
              <ng-container matColumnDef="available">
                <th mat-header-cell *matHeaderCellDef>Disponível</th>
                <td mat-cell *matCellDef="let stock">{{ stock.quantityAvailable | number:'1.0-2' }}</td>
              </ng-container>
              <ng-container matColumnDef="reserved">
                <th mat-header-cell *matHeaderCellDef>Reservado</th>
                <td mat-cell *matCellDef="let stock">{{ stock.reservedQuantity | number:'1.0-2' }}</td>
              </ng-container>
              <ng-container matColumnDef="forSale">
                <th mat-header-cell *matHeaderCellDef>Disponível p/ Venda</th>
                <td mat-cell *matCellDef="let stock">{{ stock.quantityForSale | number:'1.0-2' }}</td>
              </ng-container>
              <ng-container matColumnDef="minimum">
                <th mat-header-cell *matHeaderCellDef>Mínimo</th>
                <td mat-cell *matCellDef="let stock">{{ stock.minimumQuantity != null ? (stock.minimumQuantity | number:'1.0-2') : '-' }}</td>
              </ng-container>
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let stock">
                  <span class="stock-status" [ngClass]="'stock-' + stock.status.toLowerCase()">
                    {{ getStockStatusLabel(stock.status) }}
                  </span>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="stockColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: stockColumns;"></tr>
            </table>
          </div>

          <div class="empty-state" *ngIf="!loadingStock && (!stockData || !stockData.byLocation || stockData.byLocation.length === 0)">
            <mat-icon>inventory</mat-icon>
            <p>Nenhum registro de estoque encontrado para este produto</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Stock Levels for VARIANT_PARENT (aggregated from variants) -->
      <mat-card class="detail-card" *ngIf="product.controlsInventory && product.type === ProductType.VARIANT_PARENT">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>warehouse</mat-icon>
            Estoque por Variante
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="loading-inline" *ngIf="loadingVariantStock">
            <div class="spinner-small"></div>
            <span>Carregando estoque das variantes...</span>
          </div>

          <!-- Aggregated Summary -->
          <div class="info-grid stock-summary" *ngIf="!loadingVariantStock && !loadingVariants && variants.length > 0">
            <div class="info-item">
              <label>Total Disponível</label>
              <span class="stock-value">{{ variantStockTotals.available | number:'1.0-2' }}</span>
            </div>
            <div class="info-item">
              <label>Total Reservado</label>
              <span class="stock-reserved">{{ variantStockTotals.reserved | number:'1.0-2' }}</span>
            </div>
            <div class="info-item">
              <label>Total Disponível p/ Venda</label>
              <span class="stock-for-sale">{{ variantStockTotals.forSale | number:'1.0-2' }}</span>
            </div>
          </div>

          <!-- Variant Stock Table -->
          <div class="table-container" *ngIf="!loadingVariantStock && !loadingVariants && variants.length > 0">
            <table class="variant-stock-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Nome</th>
                  <th>Atributos</th>
                  <th class="text-right">Disponível</th>
                  <th class="text-right">Reservado</th>
                  <th class="text-right">À Venda</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let variant of variants">
                  <td class="sku-cell">{{ variant.sku }}</td>
                  <td>{{ variant.name }}</td>
                  <td class="attributes-cell">{{ formatAttributes(variant) }}</td>
                  <td class="text-right">{{ (variantStockMap.get(variant.id)?.totalQuantityAvailable || 0) | number:'1.0-2' }}</td>
                  <td class="text-right">{{ (variantStockMap.get(variant.id)?.totalReservedQuantity || 0) | number:'1.0-2' }}</td>
                  <td class="text-right">{{ (variantStockMap.get(variant.id)?.totalQuantityForSale || 0) | number:'1.0-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="empty-state" *ngIf="!loadingVariantStock && !loadingVariants && variants.length === 0">
            <mat-icon>inventory</mat-icon>
            <p>Nenhuma variante cadastrada para este produto</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Descriptive Attributes -->
      <mat-card class="detail-card" *ngIf="!loadingAttributes && productAttributes.length > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>label</mat-icon>
            Atributos Descritivos
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="attributes-grid">
            <div class="attribute-item" *ngFor="let attr of productAttributes">
              <label>{{ attr.key }}</label>
              <span>{{ attr.value }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Variants Section (VARIANT_PARENT) -->
      <mat-card class="detail-card" *ngIf="product.type === ProductType.VARIANT_PARENT">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>view_module</mat-icon>
            Variantes ({{ variants.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="loading-inline" *ngIf="loadingVariants">
            <div class="spinner-small"></div>
            <span>Carregando variantes...</span>
          </div>

          <div class="empty-state" *ngIf="!loadingVariants && variants.length === 0">
            <mat-icon>view_module</mat-icon>
            <p>Nenhuma variante cadastrada</p>
          </div>

          <div class="table-container" *ngIf="!loadingVariants && variants.length > 0">
            <table mat-table [dataSource]="variants" class="variants-table">
              <!-- SKU Column -->
              <ng-container matColumnDef="sku">
                <th mat-header-cell *matHeaderCellDef>SKU</th>
                <td mat-cell *matCellDef="let variant">{{ variant.sku }}</td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Nome</th>
                <td mat-cell *matCellDef="let variant">{{ variant.name }}</td>
              </ng-container>

              <!-- Attributes Column -->
              <ng-container matColumnDef="attributes">
                <th mat-header-cell *matHeaderCellDef>Atributos</th>
                <td mat-cell *matCellDef="let variant">
                  <span class="attributes-text">{{ formatAttributes(variant) }}</span>
                </td>
              </ng-container>

              <!-- Price Column -->
              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Preço</th>
                <td mat-cell *matCellDef="let variant">
                  {{ variant.price ? ('R$ ' + (variant.price | number:'1.2-2')) : '-' }}
                </td>
              </ng-container>

              <!-- Stock Column -->
              <ng-container matColumnDef="stock">
                <th mat-header-cell *matHeaderCellDef>Estoque</th>
                <td mat-cell *matCellDef="let variant">
                  <span *ngIf="!loadingVariantStock && product?.controlsInventory">
                    {{ getVariantStockTotal(variant.id) | number:'1.0-2' }}
                  </span>
                  <span *ngIf="!product?.controlsInventory">-</span>
                  <span *ngIf="loadingVariantStock" class="loading-text">...</span>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let variant">
                  <span class="variant-status" [ngClass]="'status-' + variant.status.toLowerCase()">
                    {{ getStatusLabel(variant.status) }}
                  </span>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="variantColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: variantColumns;"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- BOM Components Section (COMPOSITE) -->
      <mat-card class="detail-card" *ngIf="product.type === ProductType.COMPOSITE">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>inventory_2</mat-icon>
            Componentes do Kit ({{ bomComponents.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="loading-inline" *ngIf="loadingBom">
            <div class="spinner-small"></div>
            <span>Carregando componentes...</span>
          </div>

          <div class="empty-state" *ngIf="!loadingBom && bomComponents.length === 0">
            <mat-icon>inventory_2</mat-icon>
            <p>Nenhum componente cadastrado</p>
          </div>

          <div class="table-container" *ngIf="!loadingBom && bomComponents.length > 0">
            <table mat-table [dataSource]="bomComponents" class="bom-table">
              <!-- SKU Column -->
              <ng-container matColumnDef="sku">
                <th mat-header-cell *matHeaderCellDef>SKU</th>
                <td mat-cell *matCellDef="let component">{{ component.componentSku }}</td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Nome</th>
                <td mat-cell *matCellDef="let component">{{ component.componentName }}</td>
              </ng-container>

              <!-- Quantity Column -->
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef>Quantidade</th>
                <td mat-cell *matCellDef="let component">{{ component.quantityRequired }}</td>
              </ng-container>

              <!-- Unit Column -->
              <ng-container matColumnDef="unit">
                <th mat-header-cell *matHeaderCellDef>Unidade</th>
                <td mat-cell *matCellDef="let component">{{ component.unit }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="bomColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: bomColumns;"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Audit Information -->
      <mat-card class="detail-card audit-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>history</mat-icon>
            Auditoria
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>ID</label>
              <span class="id-value">{{ product.id }}</span>
            </div>
            <div class="info-item">
              <label>Criado em</label>
              <span>{{ product.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="info-item">
              <label>Atualizado em</label>
              <span>{{ product.updatedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </ng-container>
</div>
