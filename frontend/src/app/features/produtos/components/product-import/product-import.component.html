<div class="import-container">

  <!-- Header -->
  <div class="header">
    <h2>Importar Produtos</h2>
    <div class="header-actions">
      @if (!showPreview && !confirmResult) {
        <button mat-stroked-button (click)="cancel()">
          <mat-icon>arrow_back</mat-icon>
          Voltar
        </button>
      }
    </div>
  </div>

  <!-- Step indicator -->
  <div class="step-indicator">
    <div class="step" [class.active]="!showPreview && !confirmResult" [class.done]="showPreview || confirmResult">
      <span class="step-number">
        @if (showPreview || confirmResult) {
          <mat-icon>check</mat-icon>
        } @else {
          1
        }
      </span>
      Upload
    </div>
    <div class="step-line" [class.done]="showPreview || confirmResult"></div>
    <div class="step" [class.active]="showPreview && !confirmResult" [class.done]="!!confirmResult">
      <span class="step-number">
        @if (confirmResult) {
          <mat-icon>check</mat-icon>
        } @else {
          2
        }
      </span>
      Revisar
    </div>
    <div class="step-line" [class.done]="!!confirmResult"></div>
    <div class="step" [class.active]="!!confirmResult" [class.done]="!!confirmResult">
      <span class="step-number">
        @if (confirmResult) {
          <mat-icon>check</mat-icon>
        } @else {
          3
        }
      </span>
      Concluir
    </div>
  </div>

  <!-- ================================
       ETAPA 1: UPLOAD
       ================================ -->
  @if (!showPreview && !confirmResult) {

    <!-- Templates section -->
    <div class="form-section">
      <h3>
        <mat-icon>description</mat-icon>
        Templates CSV
      </h3>
      <div class="template-buttons">
        <button mat-stroked-button color="primary" (click)="downloadTemplate()">
          <mat-icon>download</mat-icon>
          Baixar Template CSV
        </button>
      </div>
      <p class="template-hint">Baixe um template para ver o formato esperado. Use o <strong>nome da categoria</strong> (ex: Eletrônicos, Informática)</p>
    </div>

    <!-- Error Alert -->
    @if (errorMessage) {
      <div class="alert-banner alert-error">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
        <button mat-icon-button (click)="errorMessage = null" class="alert-close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    }

    <!-- Upload section -->
    <div class="form-section">
      <h3>
        <mat-icon>upload_file</mat-icon>
        Selecione o Arquivo
      </h3>

      <div class="upload-area" (click)="fileInput.click()">
        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <p>Clique para selecionar ou arraste o arquivo CSV</p>
        <small>Formato aceito: .csv</small>
      </div>

      <input
        #fileInput
        type="file"
        accept=".csv"
        (change)="onFileSelected($event)"
        style="display: none;"
      />

      <!-- File selected -->
      @if (selectedFile) {
        <div class="file-info">
          <mat-icon>insert_drive_file</mat-icon>
          <div class="file-info-text">
            <div class="file-info-name">{{ selectedFile.name }}</div>
            <div class="file-info-size">{{ (selectedFile.size / 1024).toFixed(2) }} KB</div>
          </div>
          <button mat-icon-button class="remove-btn" (click)="selectedFile = null" matTooltip="Remover arquivo">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      }

      <!-- Progress bar -->
      @if (isUploading) {
        <div class="progress-bar-container">
          <mat-progress-bar mode="determinate" [value]="uploadProgress"></mat-progress-bar>
          <div class="progress-label">Processando... {{ uploadProgress }}%</div>
        </div>
      }

      <div class="form-actions">
        <button
          mat-raised-button
          color="primary"
          [disabled]="!selectedFile || isUploading"
          (click)="uploadAndPreview()">
          @if (isUploading) {
            <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
          } @else {
            <mat-icon>play_arrow</mat-icon>
          }
          {{ isUploading ? 'Processando...' : 'Processar e Visualizar' }}
        </button>
        <button mat-stroked-button (click)="cancel()">
          Cancelar
        </button>
      </div>
    </div>
  }

  <!-- ================================
       ETAPA 2: PREVIEW
       ================================ -->
  @if (showPreview && preview && !confirmResult) {

    <!-- Stats grid -->
    <div class="stats-grid">
      <div class="stat-card stat-card-default">
        <div class="stat-label">Total de Linhas</div>
        <div class="stat-value">{{ preview.totalRows }}</div>
      </div>
      <div class="stat-card stat-card-success">
        <div class="stat-label">Linhas Válidas</div>
        <div class="stat-value">{{ preview.validRows }}</div>
      </div>
      <div class="stat-card stat-card-danger">
        <div class="stat-label">Com Erros</div>
        <div class="stat-value">{{ preview.invalidRows }}</div>
      </div>
      <div class="stat-card stat-card-info">
        <div class="stat-label">Arquivo</div>
        <div class="stat-filename">{{ preview.fileName }}</div>
      </div>
    </div>

    <!-- Preview table -->
    <div class="form-section table-section">
      <div class="table-header">
        <h3>
          <mat-icon>table_chart</mat-icon>
          Prévia dos Dados
        </h3>
      </div>
      <div class="table-container">
        <table class="preview-table">
          <thead>
            <tr>
              <th style="width:50px;">#</th>
              <th style="width:50px;">Status</th>
              <th>Nome</th>
              <th>SKU</th>
              <th>Categoria</th>
              <th>Preço</th>
              <th>Erros</th>
            </tr>
          </thead>
          <tbody>
            @for (row of preview.rows; track row.rowNumber) {
              <tr [class]="row.valid ? 'row-valid' : 'row-invalid'">
                <td>{{ row.rowNumber }}</td>
                <td>
                  @if (row.valid) {
                    <mat-icon class="status-icon status-valid">check_circle</mat-icon>
                  } @else {
                    <mat-icon class="status-icon status-invalid">cancel</mat-icon>
                  }
                </td>
                <td>{{ row.name }}</td>
                <td>{{ row.sku }}</td>
                <td>{{ row.category }}</td>
                <td>{{ row.price | number:'1.2-2' }}</td>
                <td>
                  @if (row.errors.length > 0) {
                    <ul class="error-list">
                      @for (error of row.errors; track error) {
                        <li>{{ error }}</li>
                      }
                    </ul>
                  } @else {
                    <span class="no-error">-</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Alert banners -->
    @if (preview.validRows === 0) {
      <div class="alert-banner alert-warning">
        <mat-icon>warning</mat-icon>
        <span>Nenhuma linha válida encontrada. Corrija os erros e tente novamente.</span>
      </div>
    } @else {
      <div class="alert-banner alert-info">
        <mat-icon>info</mat-icon>
        <span><strong>{{ preview.validRows }} linhas válidas</strong> serão importadas. {{ preview.invalidRows }} linhas com erros serão ignoradas.</span>
      </div>
    }

    <div class="form-actions">
      <button
        mat-raised-button
        class="btn-success"
        [disabled]="preview.validRows === 0 || isConfirming"
        (click)="confirmImport()">
        @if (isConfirming) {
          <mat-spinner diameter="18" class="btn-spinner"></mat-spinner>
        } @else {
          <mat-icon>check</mat-icon>
        }
        {{ isConfirming ? 'Importando...' : 'Confirmar Importação (' + preview.validRows + ' produtos)' }}
      </button>
      <button mat-stroked-button [disabled]="isConfirming" (click)="reset()">
        <mat-icon>arrow_back</mat-icon>
        Cancelar e Voltar
      </button>
    </div>
  }

  <!-- ================================
       ETAPA 3: RESULTADO
       ================================ -->
  @if (confirmResult) {
    <div class="result-card">
      <mat-icon class="result-icon">check_circle</mat-icon>
      <h3>Importação Concluída!</h3>
      <p>{{ confirmResult.message }}</p>

      <div class="result-stats">
        <div class="result-stat">
          <span class="result-stat-value total">{{ confirmResult.totalRows }}</span>
          <span class="result-stat-label">Total</span>
        </div>
        <div class="result-stat">
          <span class="result-stat-value success">{{ confirmResult.successRows }}</span>
          <span class="result-stat-label">Importados</span>
        </div>
        <div class="result-stat">
          <span class="result-stat-value errors">{{ confirmResult.errorRows }}</span>
          <span class="result-stat-label">Erros</span>
        </div>
      </div>

      <p class="result-redirect">Redirecionando para lista de produtos...</p>
    </div>
  }

</div>
