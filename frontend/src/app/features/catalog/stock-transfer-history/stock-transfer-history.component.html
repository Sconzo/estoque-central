<mat-card>
  <mat-card-header>
    <mat-card-title id="page-title">Histórico de Transferências</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <!-- Filtros -->
    <form [formGroup]="filterForm" class="filters-section" aria-labelledby="page-title">
      <div class="filter-row">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Local de Origem</mat-label>
          <mat-select formControlName="originLocationId" aria-label="Filtrar por local de origem da transferência">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let location of locations()" [value]="location.id">
              {{ location.name }} ({{ location.code }})
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Local de Destino</mat-label>
          <mat-select formControlName="destinationLocationId" aria-label="Filtrar por local de destino da transferência">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let location of locations()" [value]="location.id">
              {{ location.name }} ({{ location.code }})
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filter-row">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Data Início</mat-label>
          <input
            matInput
            [matDatepicker]="startPicker"
            formControlName="startDate"
            aria-label="Filtrar por data inicial das transferências">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Data Fim</mat-label>
          <input
            matInput
            [matDatepicker]="endPicker"
            formControlName="endDate"
            aria-label="Filtrar por data final das transferências">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="filter-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="applyFilters()"
          [disabled]="loading()"
          [attr.aria-label]="loading() ? 'Buscando...' : 'Aplicar filtros e buscar transferências'"
          [attr.aria-disabled]="loading()">
          <mat-icon aria-hidden="true">search</mat-icon>
          Buscar
        </button>
        <button
          mat-button
          (click)="clearFilters()"
          [disabled]="loading()"
          aria-label="Limpar todos os filtros"
          [attr.aria-disabled]="loading()">
          <mat-icon aria-hidden="true">clear</mat-icon>
          Limpar Filtros
        </button>
      </div>
    </form>

    <!-- Tabela de Transferências -->
    <div class="table-container">
      <table mat-table [dataSource]="transfers()" class="transfers-table" aria-label="Tabela de transferências de estoque">
        <!-- Data/Hora Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Data/Hora</th>
          <td mat-cell *matCellDef="let transfer">
            {{ formatDate(transfer.createdAt) }}
          </td>
        </ng-container>

        <!-- Produto Column -->
        <ng-container matColumnDef="productInfo">
          <th mat-header-cell *matHeaderCellDef>Produto</th>
          <td mat-cell *matCellDef="let transfer">
            <div class="product-info">
              <div class="product-name">{{ transfer.productName }}</div>
              <div class="product-sku">{{ transfer.productSku }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Origem Column -->
        <ng-container matColumnDef="originLocation">
          <th mat-header-cell *matHeaderCellDef>Origem</th>
          <td mat-cell *matCellDef="let transfer">
            <div class="location-info">
              <div class="location-name">{{ transfer.originLocationName }}</div>
              <div class="location-code">{{ transfer.originLocationCode }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Destino Column -->
        <ng-container matColumnDef="destinationLocation">
          <th mat-header-cell *matHeaderCellDef>Destino</th>
          <td mat-cell *matCellDef="let transfer">
            <div class="location-info">
              <div class="location-name">{{ transfer.destinationLocationName }}</div>
              <div class="location-code">{{ transfer.destinationLocationCode }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Quantidade Column -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantidade</th>
          <td mat-cell *matCellDef="let transfer">
            <span class="quantity">{{ transfer.quantity | number:'1.0-3' }}</span>
          </td>
        </ng-container>

        <!-- Usuário Column -->
        <ng-container matColumnDef="userName">
          <th mat-header-cell *matHeaderCellDef>Usuário</th>
          <td mat-cell *matCellDef="let transfer">
            {{ transfer.userName || 'N/A' }}
          </td>
        </ng-container>

        <!-- Motivo Column -->
        <ng-container matColumnDef="reason">
          <th mat-header-cell *matHeaderCellDef>Motivo</th>
          <td mat-cell *matCellDef="let transfer">
            <span class="reason">{{ transfer.reason || '-' }}</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- Empty state -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell empty-state" [attr.colspan]="displayedColumns.length">
            <div class="empty-message" role="status">
              <mat-icon aria-hidden="true">inbox</mat-icon>
              <p>Nenhuma transferência encontrada</p>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="loading()" class="loading-overlay" role="status" aria-live="polite">
      <mat-icon class="spinner" aria-hidden="true">refresh</mat-icon>
      <p>Carregando transferências...</p>
    </div>
  </mat-card-content>
</mat-card>
